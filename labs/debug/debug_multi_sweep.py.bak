#!/usr/bin/env python3
"""
Script de diagnostic du système multi-sweep
Date: 23/01/2026
"""

import sys
import os

# Ajouter le répertoire racine au path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def test_sidebar_state():
    """Test de la configuration de la sidebar"""

    print("=== Diagnostic Système Multi-Sweep ===\n")

    # Simuler des sélections multiples comme l'utilisateur
    test_symbols = ["BTCUSDC", "ETHUSDC"]
    test_timeframes = ["5m", "15m", "30m"]
    test_strategy_keys = ["bollinger_long_test", "ema_cross"]

    print(f"Sélections de test:")
    print(f"  - Symbols: {test_symbols} (len={len(test_symbols)})")
    print(f"  - Timeframes: {test_timeframes} (len={len(test_timeframes)})")
    print(f"  - Strategy keys: {test_strategy_keys} (len={len(test_strategy_keys)})")

    # Test détection multi-sweep
    is_multi_sweep = (len(test_strategy_keys) > 1 or len(test_symbols) > 1 or len(test_timeframes) > 1)
    print(f"\nDétection multi-sweep: {is_multi_sweep}")

    if is_multi_sweep:
        total_combinations = len(test_strategy_keys) * len(test_symbols) * len(test_timeframes)
        print(f"Total combinaisons attendues: {total_combinations}")

        print("\nCombinaisongs qui seraient traitées:")
        counter = 0
        for strategy in test_strategy_keys:
            for symbol in test_symbols:
                for timeframe in test_timeframes:
                    counter += 1
                    print(f"  {counter:2d}. {strategy} × {symbol} × {timeframe}")

    print()

def test_data_availability():
    """Test disponibilité des données"""
    try:
        from data.loader import discover_available_data

        print("=== Test Disponibilité Données ===")
        symbols, timeframes = discover_available_data()
        print(f"Symbols disponibles: {len(symbols)} - {symbols[:5]}{'...' if len(symbols) > 5 else ''}")
        print(f"Timeframes disponibles: {len(timeframes)} - {timeframes}")

        # Test spécifique pour les symboles utilisateur
        test_symbols = ["BTCUSDC", "ETHUSDC"]
        test_timeframes = ["5m", "15m", "30m"]

        print(f"\nVérification des sélections utilisateur:")
        for symbol in test_symbols:
            available = symbol in symbols
            print(f"  {symbol}: {'✅ Disponible' if available else '❌ Manquant'}")

        for tf in test_timeframes:
            available = tf in timeframes
            print(f"  {tf}: {'✅ Disponible' if available else '❌ Manquant'}")

    except Exception as e:
        print(f"Erreur scan données: {e}")

if __name__ == "__main__":
    test_sidebar_state()
    test_data_availability()

    print("\n=== Recommandations ===")
    print("1. Vérifiez que les sélections multiples sont bien transmises au state")
    print("2. Ajoutez des logs dans les boucles multi-sweep pour tracer l'exécution")
    print("3. Vérifiez que les données sont disponibles pour tous les symboles/timeframes")
    print("4. Testez avec des symboles/timeframes très simples d'abord")