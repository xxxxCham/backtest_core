ðŸ”¹ PROMPT 1 â€” Audit STRICT (lecture seule)

(Ã  lancer en premier, sans aucun changement de code)

SYSTEM ROLE: Senior Python auditor (typing + architecture).
MODEL CONSTRAINT: Read-only. Do NOT modify code.

OBJECTIVE:
Produce a precise audit of typing and metric-unit inconsistencies.

TASKS:
1) Identify every location where metrics:
   - change unit (% vs fraction)
   - change naming (total_return vs total_return_pct, etc.)
   - are stored or transported as Dict[str, Any] or Any
2) Focus files:
   performance.py, engine.py, integration.py, backtest_executor.py,
   facade.py, storage.py, sweep.py, ui/state.py
3) Produce a table:
   file | symbol/type | expected unit | actual unit | risk | note
4) Produce a prioritized TODO list (P0/P1/P2).

OUTPUT FORMAT:
- Markdown
- Tables only (no prose except short notes)
- If uncertain, explicitly mark "UNKNOWN".

STOP AFTER AUDIT. NO CODE CHANGES.

ðŸ”¹ PROMPT 2 â€” DESIGN verrouillÃ© (types + unitÃ©s)

(Ã  lancer uniquement aprÃ¨s validation de lâ€™audit)

SYSTEM ROLE: Senior Python architect.
MODEL CONSTRAINT: Design only. No code yet.

OBJECTIVE:
Design a minimal, robust typing system to unify metrics and reduce Dict[str, Any].

TASKS:
1) Propose ONE metric unit convention:
   - Either "fractions everywhere" OR "percent everywhere"
   - Justify choice briefly.
2) Design a central module (ex: core/types.py) containing:
   - metric types (TypedDict and/or dataclass)
   - explicit conversion helpers (to_pct, to_fraction, normalize_metrics)
   - OhlcvFrame alias or Protocol
3) Define invariants (ex: win_rate âˆˆ [0,1] if fraction).
4) Provide a migration plan in 3 atomic PRs.

OUTPUT FORMAT:
- Markdown
- Section headers only
- No code blocks longer than 30 lines

ðŸ”¹ PROMPT 3 â€” FOUNDATION CODE (types + conversions)

(premiÃ¨re Ã©criture de code, trÃ¨s cadrÃ©e)

SYSTEM ROLE: Senior Python engineer.
MODEL CONSTRAINT: Minimal code. Atomic commit mindset.

OBJECTIVE:
Implement the foundation layer only.

TASKS:
1) Create the central types module as designed.
2) Implement:
   - metric dataclasses / TypedDict
   - normalize_metrics()
   - to_pct(), to_fraction()
   - validate_metrics() with light runtime checks
3) Add Pytest tests for:
   - conversions
   - invalid units detection

CONSTRAINTS:
- Do NOT modify engine, integration, UI, or facade yet.
- No external dependencies.
- Code must be typed and documented.

OUTPUT:
- Code blocks only
- One module + one test file

ðŸ”¹ PROMPT 4 â€” PIPELINE ENFORCEMENT (engine â†’ agents)

(lÃ  oÃ¹ GPT-5.2 est excellent)

SYSTEM ROLE: Senior Python engineer.
MODEL CONSTRAINT: End-to-end consistency, no feature changes.

OBJECTIVE:
Make metric unit conversions explicit across the core pipeline.

TASKS:
1) Update engine.py and performance.py to emit normalized metrics.
2) Update integration.py to explicitly normalize metrics.
3) Update backtest_executor.py to enforce unit invariants.
4) Add a minimal pipeline test:
   - fake backtest run
   - assert metric invariants end-to-end

CONSTRAINTS:
- Keep backward compatibility via adapters or aliases if needed.
- Atomic commits per file group.

OUTPUT:
- Code blocks
- Short explanation per file (max 3 bullets)

ðŸ”¹ PROMPT 5 â€” BOUNDARIES HARDENING (facade / storage / sweep)

(rÃ©duction massive des Dict[str, Any])

SYSTEM ROLE: Senior Python engineer.
MODEL CONSTRAINT: Boundary safety first.

OBJECTIVE:
Harden serialization and UI/backend contracts.

TASKS:
1) Replace Dict[str, Any] metrics in:
   - facade.py
   - storage.py
   - sweep.py
   with typed, serializable structures.
2) Maintain JSON backward compatibility.
3) Add round-trip serialization tests.

CONSTRAINTS:
- No UI logic changes.
- Explicit from_dict / to_dict if dataclass used.

OUTPUT:
- Code blocks + tests
- Compatibility notes

ðŸ”¹ PROMPT 6 â€” UI TYPING (80/20 only)

(dernier, ciblÃ©, sans explosion de scope)

SYSTEM ROLE: Senior Python engineer (typing specialist).
MODEL CONSTRAINT: 80/20 typing, no UI redesign.

OBJECTIVE:
Reduce Any usage in ui/state.py where it matters most.

TASKS:
1) Identify the 20% most used SidebarState fields.
2) Replace Any with existing types:
   - ParameterSpec
   - RoleModelConfig
   - LLMConfig
   - ExecutionConfig
   - OhlcvFrame / pd.Timestamp
3) Replace loose callbacks with Protocols if helpful.
4) Add minimal state invariant tests.

CONSTRAINTS:
- Leave non-critical fields as Any.
- No behavior changes.

OUTPUT:
- Code blocks
- Short coverage summary
